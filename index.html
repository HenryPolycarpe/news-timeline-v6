<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BTC Timeline â€” CoinGecko + GNews</title>
<link rel="preconnect" href="https://api.coingecko.com">
<link rel="preconnect" href="https://gnews.io">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
<style>
  :root{
    --h:560px; --ui:#0ea5e9; --bg:#f3f4f6; --card:#fff; --ink:#0f172a; --muted:#6b7280; --line:#cbd5e1;
    --bull-bg:#e9f8ef; --bear-bg:#ffe9ea; --good:#10b981; --bad:#ef4444;
  }
  *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,system-ui,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;gap:10px;padding:10px 14px;background:#ffffffdd;border-bottom:1px solid #e5e7eb;backdrop-filter:blur(6px)}
  .left,.right{display:flex;gap:10px;align-items:center}
  .brand{font-weight:800}
  .theme{width:20px;height:20px;border-radius:50%;border:2px solid #e5e7eb;cursor:pointer}.theme.active{outline:2px solid var(--ui)}
  .blue{background:#0ea5e9}.green{background:#22c55e}.purple{background:#a855f7}
  .dm{width:36px;height:36px;border-radius:999px;border:1px solid #d1d5db;background:#fff;display:grid;place-items:center;cursor:pointer}
  .topbar{position:absolute;left:0;right:0;bottom:-2px;height:3px;background:#e5e7eb}.prog{width:0%;height:100%;background:linear-gradient(90deg,var(--ui),#3b82f6);transition:width .25s ease}

  .grid{display:grid;grid-template-columns:360px 1fr 260px;gap:16px;padding:16px}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 8px rgba(0,0,0,.05)}
  .inner{padding:16px}
  .muted{color:var(--muted);font-size:12px}
  .kpi{display:flex;justify-content:space-between;padding:6px 0}
  .summary{background:#f9fafb;border:1px dashed #e5e7eb;border-radius:12px;padding:10px;font-size:13px;color:#374151}
  .list{margin:8px 0 0 18px;padding:0}
  .list li{margin:6px 0}

  .tl{position:relative;overflow:hidden;height:var(--h)}
  .split{position:absolute;inset:0;display:grid;grid-template-rows:1fr 1fr}
  .up{background:var(--bull-bg)} .down{background:var(--bear-bg)}
  .mid{position:absolute;left:0;right:0;height:2px;background:var(--line)}
  .layer{position:absolute;inset:0;pointer-events:none}
  .col{position:absolute;top:0;bottom:0;transform:translateX(-50%)} .vline{position:absolute;width:2px;background:var(--line)}
  .date{position:absolute;transform:translate(-50%,-50%);top:0;left:50%;padding:3px 6px;border:1px solid #e5e7eb;background:#fff;border-radius:6px;font-size:10px;color:#374151}

  .bubble{position:absolute;left:50%;transform:translate(-50%,0);border-radius:999px;display:grid;place-items:center;color:#fff;box-shadow:0 10px 22px rgba(0,0,0,.18);pointer-events:auto;overflow:hidden;transition:transform .2s ease}
  .bubble:hover{transform:translate(-50%,0) scale(1.06)}
  .neu{background:linear-gradient(145deg,#9ca3af,#6b7280)}
  .bubble img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:.25;filter:grayscale(15%)} .btxt{position:relative;font-size:11px;font-weight:800;text-shadow:0 1px 3px rgba(0,0,0,.35)}
  .top3{outline:3px solid gold;outline-offset:2px}
  .tip{position:absolute;z-index:30;background:#fff;color:#111827;border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;box-shadow:0 8px 24px rgba(0,0,0,.15);width:290px;font-size:12px;display:none}
  .tip .src{color:#64748b;font-size:11px;margin-top:4px}

  .overlay{position:fixed;inset:0;background:#ffffffd9;backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;z-index:50}
  .bar{width:360px;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}.bar>div{width:0%;height:100%;background:linear-gradient(90deg,var(--ui),#3b82f6);transition:width .25s ease}

  @media(prefers-color-scheme:dark){
    body{background:#0b0e13;color:#e5e7eb} header{background:#0f131add;border-bottom-color:#1f2937}
    .card{background:#0f131a;border-color:#1f2937}.summary{background:#0b0e13;border-color:#1f2937;color:#cbd5e1}
    .mid,.vline{background:#334155}.date{background:#0f131a;border-color:#273244;color:#cbd5e1}
    .up{background:#0c2016}.down{background:#2a0d12}.tip{background:#0f131a;border-color:#273244;color:#e5e7eb}
    .overlay{background:#0b0e13cc}
  }
</style>
</head>
<body>
<header>
  <div class="left">
    <div class="brand">ðŸ“Š BTC Timeline</div>
  </div>
  <div class="right" style="position:relative">
    <div class="theme blue active" data-t="blue" title="Blue"></div>
    <div class="theme green" data-t="green" title="Green"></div>
    <div class="theme purple" data-t="purple" title="Purple"></div>
    <button class="dm" id="dm" title="Dark mode">ðŸŒ™</button>
    <div class="topbar"><div id="topProg" class="prog"></div></div>
  </div>
</header>

<div class="grid">
  <!-- Left: summary -->
  <div class="card"><div class="inner">
    <div id="coinTitle" style="font-weight:800;font-size:18px;margin-bottom:6px">Bitcoin (BTC)</div>
    <div class="muted" style="margin-bottom:10px">Price: CoinGecko â€¢ News: GNews</div>
    <div id="stats">Loadingâ€¦</div>
    <div style="height:8px"></div>
    <div class="summary" id="summaryBox">Summary will appear after data loadsâ€¦</div>
    <div style="height:8px"></div>
    <div class="summary">
      <strong>Top 3 headlines</strong>
      <ol id="top3" class="list"></ol>
    </div>
  </div></div>

  <!-- Center: timeline -->
  <div class="card tl" id="timeline">
    <div class="split"><div class="up"></div><div class="down"></div></div>
    <canvas id="chart"></canvas>
    <div class="mid" id="centerLine"></div>
    <div class="layer" id="bubbleLayer"></div>
    <div class="tip" id="tooltip"></div>
  </div>

  <!-- Right: help -->
  <div class="card"><div class="inner">
    <div style="font-weight:700">Tips</div>
    <div class="muted" style="margin-top:6px">Tap a bubble to open the article. Hover shows source & date.</div>
    <div class="muted" style="margin-top:10px" id="metaInfo">â€”</div>
  </div></div>
</div>

<!-- overlay loader -->
<div class="overlay" id="overlay">
  <div class="bar"><div id="ovFill"></div></div>
  <div class="muted" id="ovTxt">Loadingâ€¦</div>
</div>

<script>
(()=> {
  // ========== CONFIG ==========
  const GNEWS_TOKEN = "3a3a1f803ef9a81c76b9499ba02c35fc"; // Provided by you
  const DAYS = 30;   // last 1M
  const MAX_BUBBLES = 20;

  // ========== THEME ==========
  const root=document.documentElement, topProg=document.getElementById('topProg');
  const themes=document.querySelectorAll('.theme');
  const themeMap={blue:'#0ea5e9',green:'#22c55e',purple:'#a855f7'};
  function setTheme(t){ themes.forEach(d=>d.classList.toggle('active',d.dataset.t===t)); root.style.setProperty('--ui', themeMap[t]||'#0ea5e9'); localStorage.setItem('ct_theme',t); }
  setTheme(localStorage.getItem('ct_theme')||'blue');
  themes.forEach(d=> d.onclick=()=> setTheme(d.dataset.t));
  document.getElementById('dm').onclick=()=> document.body.classList.toggle('force-dark');
  const setTop=p=> topProg.style.width=p+'%';

  // ========== ELEMENTS ==========
  const statsBox=document.getElementById('stats');
  const summaryBox=document.getElementById('summaryBox');
  const top3List=document.getElementById('top3');
  const bubbleLayer=document.getElementById('bubbleLayer');
  const centerLine=document.getElementById('centerLine');
  const tip=document.getElementById('tooltip');
  const metaInfo=document.getElementById('metaInfo');
  const overlay=document.getElementById('overlay'), ovFill=document.getElementById('ovFill'), ovTxt=document.getElementById('ovTxt');
  const showOverlay=(t='Loadingâ€¦')=>{ overlay.style.display='flex'; ovTxt.textContent=t; ovFill.style.width='0%'; };
  const stepOverlay=(p,t)=>{ ovFill.style.width=p+'%'; if(t) ovTxt.textContent=t; };
  const hideOverlay=()=> overlay.style.display='none';

  // ========== CHART ==========
  let chart, chartData=[];
  async function loadPrices(){
    setTop(10);
    const url=`https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=${DAYS}`;
    const r=await fetch(url); const data=await r.json();
    const prices=(data.prices||[]); chartData = prices.map(p=>({t:p[0], y:p[1]}));
    const ctx=document.getElementById('chart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx,{
      type:'line',
      data:{datasets:[{data:chartData,parsing:{xAxisKey:'t',yAxisKey:'y'},borderColor:'#0f172a',borderWidth:2,pointRadius:0,tension:.25}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{x:{type:'time',time:{unit:'week'},grid:{display:false}},y:{grid:{color:'rgba(148,163,184,.25)'}}},plugins:{legend:{display:false},tooltip:{enabled:false}}}
    });
    const first=prices[0]?.[1], last=prices.at(-1)?.[1], ch=((last-first)/first)*100;
    statsBox.innerHTML = `
      <div class="kpi"><span>Price</span><strong>$${fmt(last)}</strong></div>
      <div class="kpi"><span>Change (1M)</span><strong class="${ch>=0?'good':'bad'}">${(ch||0).toFixed(2)}%</strong></div>`;
    setTop(30);
    return {first,last,ch};
  }

  // ========== NEWS (GNews) ==========
  function toDomain(url){ try{ return new URL(url).hostname.replace(/^www\./,''); }catch(e){ return ''; } }
  async function loadNews(){
    setTop(55);
    const toISO = new Date().toISOString();
    const fromISO = new Date(Date.now()-DAYS*86400000).toISOString();
    const q = encodeURIComponent(`Bitcoin OR BTC cryptocurrency`);
    const url = `https://gnews.io/api/v4/search?q=${q}&lang=en&country=us&from=${fromISO}&to=${toISO}&in=title&max=50&sortby=publishedAt&token=${GNEWS_TOKEN}`;
    const r=await fetch(url); if(!r.ok) throw new Error('GNews error '+r.status);
    const data=await r.json();
    const items=(data.articles||[]).map(a=>({
      title:a.title, url:a.url, image:a.image||'', domain: a.source?.name? a.source.name.toLowerCase().replace(/^www\./,'') : toDomain(a.url),
      ts: Date.parse(a.publishedAt), desc: a.description||''
    })).filter(x=> x.ts && x.url && x.title);
    setTop(75);
    return items;
  }

  // ========== RENDER ==========
  const fmt = v => v==null?'â€”': v>1e12?(v/1e12).toFixed(2)+'T': v>1e9?(v/1e9).toFixed(2)+'B': v>1e6?(v/1e6).toFixed(2)+'M': (Math.round(v*100)/100).toLocaleString();
  const pxFor = (ms) => chart.scales.x.getPixelForValue(ms);

  function renderBubbles(items, kpi){
    bubbleLayer.innerHTML='';
    // rank (neutral relevance = recency + source weight)
    const start = Date.now()-DAYS*86400000;
    items = items.filter(i=> i.ts>=start);
    items.forEach(i=>{
      const ageDays = (Date.now()-i.ts)/86400000;
      const rec = Math.max(0, 1 - ageDays/30);
      const src = /coindesk|cointelegraph|decrypt|reuters|bloomberg|wsj|ft\.com/i.test(i.domain)?1:0.7;
      i.rel = 0.8*rec + 0.2*src; // 0..1
    });
    items.sort((a,b)=> b.rel - a.rel);
    const list = items.slice(0, MAX_BUBBLES).sort((a,b)=> a.ts - b.ts);

    // centerline
    const h = document.getElementById('timeline').clientHeight;
    const cy = h/2; centerLine.style.top = cy+'px';

    // top 3
    const top3 = [...list].sort((a,b)=> b.rel - a.rel).slice(0,3);
    top3List.innerHTML = top3.map(n=> `<li><a href="${n.url}" target="_blank" rel="noopener">${escapeHtml(n.title)}</a> <span class="muted">(${n.domain})</span></li>`).join('');

    // summary
    const ch = kpi.ch||0;
    const snip = list.slice(0,5).map(n=> n.title.replace(/\s+/g,' ').trim()).join(' â€¢ ');
    summaryBox.innerHTML = `
      <div><strong>Bitcoin</strong> moved <strong class="${ch>=0?'good':'bad'}">${(ch||0).toFixed(2)}%</strong> over the last <strong>1M</strong>.</div>
      <div class="muted">${escapeHtml(snip)}</div>`;

    // draw bubbles (neutral: on center line, slight alternating offset for readability)
    const tip = document.getElementById('tooltip');
    list.forEach((n, idx)=>{
      const x = pxFor(n.ts);
      const offset = ((idx%2===0)? -1 : 1) * (20 + (idx%5)*6); // small visual stagger
      const y = cy + offset;
      const size = 22 + Math.min(1, Math.max(0, n.rel))*48;

      const col=document.createElement('div'); col.className='col'; col.style.left=x+'px';
      const v=document.createElement('div'); v.className='vline'; v.style.top=Math.min(cy,y)+'px'; v.style.height=Math.abs(cy-y)+'px'; v.style.left='50%'; v.style.transform='translateX(-50%)';
      const tag=document.createElement('div'); tag.className='date'; tag.style.top=cy+'px'; tag.textContent=new Date(n.ts).toLocaleDateString();

      const b=document.createElement('div'); b.className='bubble neu'+(top3.includes(n)?' top3':'');
      b.style.width=size+'px'; b.style.height=size+'px'; b.style.top=(y - size/2)+'px'; b.title=n.title;
      b.addEventListener('click',()=> window.open(n.url,'_blank','noopener'));
      const img=document.createElement('img'); img.src = n.image || `https://www.google.com/s2/favicons?domain=${encodeURIComponent(n.domain)}&sz=64`; img.alt=''; b.appendChild(img);
      const t=document.createElement('div'); t.className='btxt'; t.textContent = Math.round(50 + n.rel*50); b.appendChild(t);

      b.addEventListener('mouseenter', e=>{
        tip.style.display='block'; tip.style.left=(e.pageX+12)+'px'; tip.style.top=(e.pageY-10)+'px';
        tip.innerHTML = `<strong>${escapeHtml(n.title)}</strong><div class="src">${escapeHtml(n.domain)} â€¢ ${new Date(n.ts).toLocaleString()}</div><div class="muted">${escapeHtml(n.desc||'')}</div>`;
      });
      b.addEventListener('mouseleave', ()=> tip.style.display='none');

      col.appendChild(v); col.appendChild(tag); col.appendChild(b); bubbleLayer.appendChild(col);
    });

    metaInfo.textContent = `Showing ${list.length} bubbles â€¢ Data: CoinGecko (price), GNews (news)`;
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // ========== PIPELINE ==========
  async function init(){
    try{
      showOverlay('Loading BTCâ€¦'); stepOverlay(10,'Priceâ€¦');
      const kpi = await loadPrices();
      stepOverlay(55,'Newsâ€¦');
      const news = await loadNews();
      stepOverlay(85,'Renderingâ€¦');
      renderBubbles(news, kpi);
      setTop(100); stepOverlay(100,'Done'); setTimeout(hideOverlay, 350);
    }catch(e){
      console.error(e);
      ovTxt.textContent='Load error. Please refresh.';
      ovFill.style.background='#ef4444';
    }
  }

  // ========== START ==========
  init();
})();
</script>
</body>
</html>